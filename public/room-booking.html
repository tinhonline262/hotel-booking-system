<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ƒê·∫∑t ph√≤ng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/room-types.css">
    <link rel="stylesheet" href="css/rooms.css">
    <style>
        main { max-width:520px; margin: 48px auto; background: #fff; border-radius:12px; box-shadow:0 0 20px #0001; padding:36px 36px 28px 36px; }
        h2, h3 { color: var(--color-primary);}
        .booking-summary { padding:14px 0 18px 0; border-bottom:1px solid #e3e4ee; margin-bottom:18px;}
        .booking-form label { font-weight:500; margin-top:14px; font-size:15px;}
        .booking-form input, .booking-form textarea { width:100%; padding:9px 11px; margin-top:7px; border:1px solid #c3cee0; border-radius:6px; font-size:15px;}
        .flex-row { display:flex; gap:12px;}
        .flex-row > div { flex:1;}
        .booking-action-btns { display:flex; gap:24px; margin-top:25px;}
        .booking-action-btns button { flex:1; }
        .booking-confirm { background:#ddf8de;border:1px solid #bdf1bb;padding:15px 18px;border-radius:8px;margin:15px 0;}
        .text-danger { color: var(--color-danger);}
        .booking-form button[disabled] { background: var(--color-gray-500);}
        .booking-form button { width:100%; margin-top:24px; height:44px;}
    </style>
</head>
<body>
<main>
    <h2>ƒê·∫∑t ph√≤ng</h2>
    <div class="booking-summary" id="room-info"></div>
    <form class="booking-form" id="booking-form" autocomplete="off" style="display:block;">
        <label for="customer_name">T√™n kh√°ch h√†ng*</label>
        <input required id="customer_name" name="customer_name" type="text" autocomplete="name">
        <label for="customer_email">Email*</label>
        <input required id="customer_email" name="customer_email" type="email" autocomplete="email">
        <label for="customer_phone">S·ªë ƒëi·ªán tho·∫°i*</label>
        <input required id="customer_phone" name="customer_phone" type="tel">
        <div class="flex-row">
            <div>
                <label for="check_in">Check-in*</label>
                <input required id="check_in" name="check_in" type="date" min="">
            </div>
            <div>
                <label for="check_out">Check-out*</label>
                <input required id="check_out" name="check_out" type="date" min="">
            </div>
        </div>
        <label for="num_guests">S·ªë kh√°ch*</label>
        <input required id="num_guests" name="num_guests" type="number" min="1" max="20" value="1">
        <label for="special_requests">Y√™u c·∫ßu ƒë·∫∑c bi·ªát</label>
        <textarea id="special_requests" name="special_requests" rows="2"></textarea>
        <button type="submit" id="bookingSubmit" disabled>ƒê·∫∑t ph√≤ng</button>
    </form>
    <div id="confirmation" style="display:none;"></div>
</main>
<script>
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('id');
    let roomData = null;
    let roomTypeData = null;
    function viMoney(x) { if (!x) return '-'; return Number(x).toLocaleString('vi-VN') + ' ƒë'; }
    if (!roomId) {
        document.getElementById('room-info').innerHTML = "<b class='text-danger'>Kh√¥ng t√¨m th·∫•y th√¥ng tin ph√≤ng!</b>";
        document.getElementById('booking-form').style.display = 'none';
    } else {
        // L·∫•y chi ti·∫øt ph√≤ng tr∆∞·ªõc, sau ƒë√≥ l·∫•y chi ti·∫øt lo·∫°i ph√≤ng (d·ª±a v√†o room_type_id)
        fetch('/api/rooms/' + roomId)
            .then(res => res.json())
            .then(roomRes => {
                if (!roomRes.success || !roomRes.data) {
                    document.getElementById('room-info').innerHTML = "<b class='text-danger'>Kh√¥ng t√¨m th·∫•y th√¥ng tin ph√≤ng!</b>";
                    document.getElementById('booking-form').style.display = 'none';
                } else {
                    roomData = roomRes.data;
                    fetch('/api/room-types/' + roomData.room_type_id)
                        .then(res => res.json())
                        .then(typeRes => {
                            roomTypeData = typeRes && typeRes.success && typeRes.data ? typeRes.data : {};
                            renderRoom(roomData, roomTypeData);
                        });
                }
            });
    }
    function renderRoom(room, type) {
        document.getElementById('room-info').innerHTML = `
        <b>Ph√≤ng ${room.room_number}</b> (${type.name || room.room_type_id || '-'})<br>
        Gi√°/ƒë√™m: <span style="color:green"><b>${viMoney(type.pricePerNight)}</b></span><br>
        S·ª©c ch·ª©a: ${type.capacity || '-'} kh√°ch<br>
        Ti·ªán nghi: ${type.amenities || '-'}<br>
        Tr·∫°ng th√°i: <span>${ room.status === 'available'
            ? '<span style="color:#059669">C√≤n tr·ªëng</span>'
            : room.status === 'occupied'
                ? '<span style="color:#b91c1c">ƒê√£ thu√™</span>'
                : room.status === 'cleaning'
                    ? '<span style="color:#c2410c">ƒêang d·ªçn</span>'
                    : room.status === 'maintenance'
                        ? '<span style="color:#6d28d9">B·∫£o tr√¨</span>'
                        : room.status || '-' }</span>
    `;
        let today = (new Date()).toISOString().split('T')[0];
        document.getElementById('check_in').setAttribute('min', today);
        document.getElementById('check_out').setAttribute('min', today);
    }
    const allFields = [
        'customer_name', 'customer_email', 'customer_phone', 'check_in', 'check_out', 'num_guests'
    ];
    function validateForm() {
        let ok = true;
        for (const id of allFields) {
            const val = (document.getElementById(id).value || '').trim();
            if (!val) ok = false;
        }
        let check_in = document.getElementById('check_in').value;
        let check_out = document.getElementById('check_out').value;
        if (check_in && check_out) ok = ok && (new Date(check_out) > new Date(check_in));
        return ok;
    }
    document.getElementById('booking-form').addEventListener('input', function() {
        document.getElementById('bookingSubmit').disabled = !validateForm();
    });
    document.getElementById('booking-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!validateForm()) return;
        const form = e.target;
        const formData = {
            customer_name: form.customer_name.value,
            customer_email: form.customer_email.value,
            customer_phone: form.customer_phone.value,
            check_in_date: form.check_in.value,
            check_out_date: form.check_out.value,
            num_guests: parseInt(form.num_guests.value),
            special_requests: form.special_requests.value || null
        };
        let type = roomTypeData || {};
        let price = type.pricePerNight ? parseFloat(type.pricePerNight) : 0;
        let days = Math.ceil((new Date(formData.check_out_date) - new Date(formData.check_in_date)) / (1000 * 60 * 60 * 24));
        days = days > 0 ? days : 1;
        let totalPrice = price * days;
        let todayStr = (new Date()).toISOString().split('T')[0].replaceAll('-','');
        let bookingCode = `BK-${roomData.id}-${todayStr}`;
        document.getElementById('booking-form').style.display = 'none';
        document.getElementById('confirmation').style.display = 'block';
        document.getElementById('confirmation').innerHTML = `
        <div class="booking-confirm">
            <h3>X√°c nh·∫≠n ƒë·∫∑t ph√≤ng</h3>
            <div><b>Ph√≤ng:</b> ${roomData.room_number} (${type.name || ''})<br>
            Gi√°/ƒë√™m: <b>${viMoney(price)}</b> | S·ªë ng√†y: ${days} | T·ªïng ti·ªÅn: <span style="color:#187700">${viMoney(totalPrice)}</span><br>
            Booking code: <b>${bookingCode}</b></div>
            <hr>
            <div>Kh√°ch: <b>${formData.customer_name}</b>, Email: ${formData.customer_email}, ƒêT: ${formData.customer_phone}</div>
            <div>Check-in: <b>${formData.check_in_date}</b> | Check-out: <b>${formData.check_out_date}</b> | S·ªë kh√°ch: ${formData.num_guests}</div>
            <div>Y√™u c·∫ßu: ${formData.special_requests ? formData.special_requests : '-'}</div>
            <div class="booking-action-btns">
                <button onclick="window.location.reload()">Hu·ª∑</button>
                <button onclick="submitFinalBooking()">X√°c nh·∫≠n</button>
            </div>
            <div id="loading-update-room"></div>
        </div>
    `;
        window._finalBooking = {
            room_id: roomData.id,
            booking_code: bookingCode,
            ...formData,
            total_price: totalPrice
        };
    });
    function submitFinalBooking() {
        let data = window._finalBooking;
        document.getElementById('loading-update-room').innerHTML = "ƒêang x·ª≠ l√Ω, vui l√≤ng ch·ªù...";
        fetch('/api/rooms/' + data.room_id, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                room_number: roomData.room_number,
                room_type_id: roomData.room_type_id,
                status: 'occupied'
            })
        })
            // Sau khi update tr·∫°ng th√°i ph√≤ng th√†nh c√¥ng, g·ª≠i booking (n·∫øu mu·ªën ƒë·ªïi th·ª© t·ª± th√¨ ƒë·ªïi l·∫°i)
            .then(()=> {
                fetch('/api/booking/rooms/' + data.room_id, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(data)
                })
                    .then(async res => {
                        let ret = await res.json();
                        if (ret.success) {
                            document.getElementById('confirmation').innerHTML = `<div class="booking-confirm">
                    <h2>üéâ ƒê·∫∑t ph√≤ng th√†nh c√¥ng!</h2>
                    M√£ booking: <b>${data.booking_code}</b>
                    <div style="margin-top:12px;"><a href="rooms-list.html" style="color:#0057ff;">‚Üê Xem danh s√°ch ph√≤ng</a></div>
                </div>`;
                        } else {
                            document.getElementById('confirmation').innerHTML =
                                `<div class="booking-confirm text-danger"><b>ƒê·∫∑t ph√≤ng th·∫•t b·∫°i!</b><br>${ret.message||''}</div>`;
                        }
                    }).catch(()=>{
                    document.getElementById('confirmation').innerHTML =
                        `<div class="booking-confirm text-danger"><b>L·ªói k·∫øt n·ªëi server!</b></div>`;
                });
            }).catch(() => {
            document.getElementById('confirmation').innerHTML = `<div class="booking-confirm text-danger"><b>L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i ph√≤ng!</b></div>`;
        });
    }
</script>
</body>
</html>