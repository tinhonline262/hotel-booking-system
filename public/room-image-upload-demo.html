<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Image Upload - Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 3px solid #4CAF50; }
        .section { margin-bottom: 40px; }
        .section h2 { color: #555; margin-bottom: 15px; font-size: 1.3em; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #666; font-weight: 500; }
        input[type="number"], input[type="file"], select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; }
        input[type="file"] { padding: 10px; }
        button { background: #4CAF50; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .status-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 4px solid #4CAF50; }
        .status-card.error { border-left-color: #f44336; }
        .status-card h3 { margin-bottom: 10px; color: #333; }
        .status-card p { color: #666; margin: 5px 0; }
        .response { margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .response pre { white-space: pre-wrap; word-wrap: break-word; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; color: #666; transition: all 0.3s; }
        .tab.active { color: #4CAF50; border-bottom: 3px solid #4CAF50; margin-bottom: -2px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .file-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .file-preview img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; border: 2px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè® Room Image Upload - Admin Panel</h1>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">Upload Images</button>
            <button class="tab" onclick="switchTab('manage')">Manage Images</button>
            <button class="tab" onclick="switchTab('storage')">Storage Info</button>
            <button class="tab" onclick="switchTab('health')">Health Check</button>
        </div>

        <!-- Upload Tab -->
        <div id="upload" class="tab-content active">
            <div class="section">
                <h2>Upload Multiple Images</h2>
                <form id="uploadForm">
                    <div class="form-group">
                        <label>Room ID:</label>
                        <input type="number" id="roomId" value="1" required>
                    </div>

                    <div class="form-group">
                        <label>Storage Type:</label>
                        <select id="storageType">
                            <option value="local">Local Storage (Default)</option>
                            <option value="cloudinary">Cloudinary</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Select Images (Multiple):</label>
                        <input type="file" id="imageFiles" accept="image/*" multiple required>
                        <div id="filePreview" class="file-preview"></div>
                    </div>

                    <button type="submit">Upload Images</button>
                </form>

                <div id="uploadResponse" class="response" style="display:none;"></div>
            </div>
        </div>

        <!-- Manage Tab -->
        <div id="manage" class="tab-content">
            <div class="section">
                <h2>Set Primary Image</h2>
                <form id="setPrimaryForm">
                    <div class="form-group">
                        <label>Image ID:</label>
                        <input type="number" id="primaryImageId" required>
                    </div>
                    <div class="form-group">
                        <label>Room ID:</label>
                        <input type="number" id="primaryRoomId" value="1" required>
                    </div>
                    <button type="submit">Set as Primary</button>
                </form>
                <div id="primaryResponse" class="response" style="display:none;"></div>
            </div>

            <div class="section">
                <h2>Delete Image</h2>
                <form id="deleteForm">
                    <div class="form-group">
                        <label>Image ID:</label>
                        <input type="number" id="deleteImageId" required>
                    </div>
                    <button type="submit">Delete Image</button>
                </form>
                <div id="deleteResponse" class="response" style="display:none;"></div>
            </div>
        </div>

        <!-- Storage Tab -->
        <div id="storage" class="tab-content">
            <div class="section">
                <h2>Storage Information</h2>
                <button onclick="getStorageInfo()">Refresh Storage Info</button>
                <div id="storageInfo" class="status-grid"></div>
            </div>

            <div class="section">
                <h2>Switch Storage Provider</h2>
                <form id="switchProviderForm">
                    <div class="form-group">
                        <label>Select Provider:</label>
                        <select id="newProvider">
                            <option value="local">Local Storage</option>
                            <option value="cloudinary">Cloudinary</option>
                        </select>
                    </div>
                    <button type="submit">Switch Provider</button>
                </form>
                <div id="switchResponse" class="response" style="display:none;"></div>
            </div>
        </div>

        <!-- Health Tab -->
        <div id="health" class="tab-content">
            <div class="section">
                <h2>Storage Health Check</h2>
                <button onclick="checkHealth()">Run Health Check</button>
                <div id="healthInfo" class="status-grid"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        document.getElementById('imageFiles').addEventListener('change', function(e) {
            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('room_id', document.getElementById('roomId').value);
            formData.append('storage_type', document.getElementById('storageType').value);
            const files = document.getElementById('imageFiles').files;
            for (let i = 0; i < files.length; i++) {
                formData.append('images[]', files[i]);
            }
            showResponse('uploadResponse', 'Uploading...', false);
            try {
                const response = await fetch(`${API_BASE}/rooms/images/upload`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                showResponse('uploadResponse', JSON.stringify(result, null, 2), result.success);
            } catch (error) {
                showResponse('uploadResponse', `Error: ${error.message}`, false);
            }
        });

        document.getElementById('setPrimaryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = {
                image_id: parseInt(document.getElementById('primaryImageId').value),
                room_id: parseInt(document.getElementById('primaryRoomId').value)
            };
            try {
                const response = await fetch(`${API_BASE}/rooms/images/set-primary`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showResponse('primaryResponse', JSON.stringify(result, null, 2), result.success);
            } catch (error) {
                showResponse('primaryResponse', `Error: ${error.message}`, false);
            }
        });

        document.getElementById('deleteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!confirm('Are you sure you want to delete this image?')) return;
            const data = {
                image_id: parseInt(document.getElementById('deleteImageId').value)
            };
            try {
                const response = await fetch(`${API_BASE}/rooms/images/delete`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showResponse('deleteResponse', JSON.stringify(result, null, 2), result.success);
            } catch (error) {
                showResponse('deleteResponse', `Error: ${error.message}`, false);
            }
        });

        async function getStorageInfo() {
            try {
                const response = await fetch(`${API_BASE}/storage/info`);
                const result = await response.json();
                if (result.success) {
                    const container = document.getElementById('storageInfo');
                    container.innerHTML = '';
                    Object.entries(result.data).forEach(([type, info]) => {
                        if (typeof info === 'object' && !Array.isArray(info)) {
                            const card = createStatusCard(type.toUpperCase(), info);
                            container.appendChild(card);
                        }
                    });
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/storage/health`);
                const result = await response.json();
                if (result.success) {
                    const container = document.getElementById('healthInfo');
                    container.innerHTML = '';
                    Object.entries(result.data).forEach(([type, health]) => {
                        const card = createHealthCard(type.toUpperCase(), health);
                        container.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        document.getElementById('switchProviderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = {
                provider: document.getElementById('newProvider').value
            };
            try {
                const response = await fetch(`${API_BASE}/storage/provider`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showResponse('switchResponse', JSON.stringify(result, null, 2), result.success);
            } catch (error) {
                showResponse('switchResponse', `Error: ${error.message}`, false);
            }
        });

        function showResponse(elementId, text, isSuccess) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = `<pre class="${isSuccess ? 'success' : 'error'}">${text}</pre>`;
        }

        function createStatusCard(title, info) {
            const card = document.createElement('div');
            card.className = 'status-card';
            let html = `<h3>${title}</h3>`;
            Object.entries(info).forEach(([key, value]) => {
                html += `<p><strong>${key}:</strong> ${value}</p>`;
            });
            card.innerHTML = html;
            return card;
        }

        function createHealthCard(title, health) {
            const card = document.createElement('div');
            card.className = `status-card ${health.status === 'unhealthy' ? 'error' : ''}`;
            let html = `<h3>${title}</h3>`;
            html += `<p><strong>Status:</strong> ${health.status}</p>`;
            if (health.issues && health.issues.length > 0) {
                html += `<p><strong>Issues:</strong></p><ul>`;
                health.issues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += `</ul>`;
            } else {
                html += `<p style="color: #4CAF50;">‚úì All checks passed</p>`;
            }
            card.innerHTML = html;
            return card;
        }

        window.addEventListener('load', () => {
            getStorageInfo();
            checkHealth();
        });
    </script>
</body>
</html>
        return new CloudinaryImageStorage(
            $config['cloud_name'] ?? '',
            $config['api_key'] ?? '',
            $config['api_secret'] ?? '',
            $config['folder'] ?? 'hotel/rooms'
        );

